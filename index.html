<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
  </style>
</head>
<script src="https://unpkg.com/moment"></script>
<!-- <script src="/moment.js"></script> -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>


<body onload='logIn()'>
  <script>
    var socket = io();
    var first, m, name = '', d = '';

    function logIn() {
      do {
        name = window.prompt('Enter your name or nickname:' + d);
        if (name == 'null') { name = "" }
        name.trim();
        d = '\n(at least four characters required)';
      } while (name.length < 4);
      socket.emit('new user', name);
      first = document.getElementById('first');
      m = document.getElementById('m');
      m.focus();
    }
    $(function () {
      $('form').submit(function (e) {
        e.preventDefault(); // prevents page reloading
        var msg = $('#m').val().trim();
        if (msg.length > 0 ){
          socket.emit('chat message', msg);
          $('#m').val('');
        }
        return false;
      });
      socket.on('chat message', function (msg) {
        var li = document.createElement('li');
        li.innerText = timeString(msg.tid) + ' ' + msg.from + ': ' + msg.msg;
        first.before(li);
        first = li;
      });
      socket.on('users', function (users) {
        $('#users').empty();
        for (var u of users) {
          var tid = timeString(u.tid);
          var usr = $('<li>').text(tid + ' ' + u.name);
          $('#users').append(usr);
        }
      });
      socket.on('history', function (msgs) {
        for (var i = 0; i < msgs.length; i++) {
          var li = document.createElement('li');
          var msg = msgs[i];
          li.innerText = timeString(msg.tid) + ' ' + msg.from + ': ' + msg.msg;
          first.before(li);
          first = li;
        }
      });
      socket.on('connect', function () {
        console.log('form: ' + socket.id)
      })
    });

    var hourOffset = -1;
    function timeString(dat) {
      if (dat === undefined){return '';}
      //var d = new Date(dat);
      //d.setHours(d.getHours + hourOffset);
      //var t = d.toISOString().substr(11, 8);
      var t = dat.substr(16, 8);
      return t;
    }

  </script>


  <div id='container'>
    <div id='Users'>
      <ul id="users"></ul>
    </div>
    <div id='Messages'>
      <ul id="messages">
        <li id='first'>f√∂rsta</li>
      </ul>
    </div>
    <div id='Tools'>
      Keyboard controls:<br>
      <!-- I: Choose icon<br> -->
    </div>
  </div>
  <form action="">
    <input id="m" autocomplete="off"
      placeholder="Type here and use the 'Enter' key or 'Send' button to send your message." /><button>Send</button>
  </form>
</body>

</html>